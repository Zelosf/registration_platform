{% extends 'base.html' %}

{% block content %}
<h1>Programs</h1>
<div class="row">
    {% if request.user.is_superuser %}
        <p>Привет, админ!</p>
    {% else %}
        <p>Привет, {{ request.user.username }}!</p>
    {% endif %}
    {% for program in programs %}
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title">{{ program.event_name }}</h4>
                <h5 class="card-title">{{ program.event_date }}</h5>
                <p class="card-text">Start Time: {{ program.start_time }}</p>
                <p class="card-text">End Time: {{ program.end_time }}</p>
                <p class="card-text">Description: {{ program.description }}</p>
                <p class="card-text">Available Tickets: {{ program.available_tickets }}/{{ program.total_tickets }}</p>
                <p class="card-text">
                    Speaker:
                    {% if program.speaker_name %}
                        <a href="{% url 'speaker_detail' program.speaker %}">{{ program.speaker_name }}</a>
                    {% else %}
                        {{ program.speaker_name }}
                    {% endif %}
                </p>
                <form id="register-form-{{ program.id }}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">Register</button>
                </form>
                <script>
                    document.getElementById('register-form-{{ program.id }}').addEventListener('submit', function(event) {
                        event.preventDefault();
                        fetch('/api/register/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}',
                            },
                            body: JSON.stringify({
                                program: {{ program.id }},
                                user: {{ request.user.id }}
                            }),
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(data => {
                                    throw new Error(data.message || 'Unknown error');
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                alert('Registration successful!');
                            } else {
                                alert('Registration failed: ' + (data.message || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Registration failed: ' + error.message);
                        });
                    });
                </script>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}